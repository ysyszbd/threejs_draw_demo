<!--
 * @LastEditTime: 2024-03-22 17:32:46
 * @Description: 
-->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
    />
    <link type="text/css" rel="stylesheet" href="main.css" />
    <style></style>
  </head>
  <body>
    <div>
      <canvas id="canvas_demo"></canvas>
    </div>
    <script type="text/javascript" src="libde265.js"></script>
    <script>
      let dom = document.getElementById("canvas_demo");
      let objs,
        data = new Map(),
        key = [],
        view;
      let video_265 = new libde265.Decoder(dom);
      video_265.set_image_callback((msg) => {
        imageDataHandler(msg);
      });
      // 在发送方的代码中
      const imageDataHandler = async (data) => {
        let imageBitmap = await drawVideoBg(data, view, data.get_width(), data.get_height());
        update({
          info: imageBitmap,
          key: key, 
          view: view
        });
        data.free();
      };
      function update(data) {
        window.parent.postMessage({ params: data, view: view, key: key }, "*");
      }
      function drawVideoBg(info, view, width, height) {
        // console.log(info, objs, view, width, height, "==================");
        return new Promise((resolve, reject) => {
          let w = width,
            h = height;
          let canvas = new OffscreenCanvas(w, h);
          let context = canvas.getContext("2d");
          let imageBitmap;
          let imagesData = context.createImageData(w, h);
          info.display(imagesData, (data) => {
            context.putImageData(data, 0, 0);
            imageBitmap = canvas.transferToImageBitmap();
            resolve(imageBitmap);
          });
        });
      }
      window.addEventListener(
        "message",
        function (event) {
          var data = event.data;
          key = data.key;
          view = data.view;
          // 然后就可以获得vue传过来的数据
          // console.log("从vue中获得的数据", data);
          video_265.push_data(data.params.video);
          video_265.decode((err) => {
            switch (err) {
              case libde265.DE265_ERROR_WAITING_FOR_INPUT_DATA:
                console.info("解码：等待数据... ", data.params.video.length);
                break;
              default:
                if (!libde265.de265_isOK(err)) {
                  console.log(libde265.de265_get_error_text(err));
                }
            }
          });
        },
        "*"
      );
    </script>
  </body>
</html>
